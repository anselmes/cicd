name: Build Workflow
description: Workflow for building images

inputs:
  build-container-image:
    default: "false"
    description: Build container images
  container-image-build-args:
    description: Container image build args
  container-image-context:
    default: .
    description: Container image context
  container-image-tags:
    description: Container image tags
  container-image-labels:
    description: Container image labels
  container-image-file:
    description: Container image file
  container-image-name:
    description: Container image name
  container-image-platforms:
    default: linux/amd64,linux/arm64
    description: Container image platforms
  container-image-repo-password:
    description: Container image repository password
  container-image-repo-username:
    description: Container image repository username
  container-image-repo:
    default: ghcr.io
    description: Container image repository
  push-container-image:
    default: "false"
    description: Push container images

runs:
  using: composite
  steps:
    # TODO: #23 setup cosign
    - name: Set up QEMU
      uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0 https://github.com/docker/setup-qemu-action/commit/29109295f81e9208d7d86ff1c6c12d2833863392
      if: ${{ inputs.build-container-image == 'true' }}
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1 https://github.com/docker/setup-buildx-action/commit/e468171a9de216ec08956ac3ada2f0791b6bd435
      if: ${{ inputs.build-container-image == 'true' }}
    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@902fa8ec7d6ecbf8d84d538b9b233a880e428804 # v5.7.0 https://github.com/docker/metadata-action/commit/902fa8ec7d6ecbf8d84d538b9b233a880e428804
      if: ${{ inputs.build-container-image == 'true' }}
      with:
        images: ${{ inputs.container-image-name }}
        labels: ${{ inputs.container-image-labels }}
        tags: ${{ inputs.container-image-tags }}
    - name: Login to Container Registry
      uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0 https://github.com/docker/login-action/commit/74a5d142397b4f367a81961eba4e8cd7edddf772
      if: ${{ inputs.build-container-image == 'true' && inputs.push-container-image == 'true' }}
      with:
        registry: ${{ inputs.container-image-repo }}
        username: ${{ inputs.container-image-repo-username }}
        password: ${{ inputs.container-image-repo-password }}
    - name: Build and push
      id: build
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0 https://github.com/docker/build-push-action/commit/263435318d21b8e681c14492fe198d362a7d2c83
      if: ${{ inputs.build-container-image == 'true' }}
      env:
        CONTEXT: ${{ inputs.container-image-context }}
      with:
        context: $CONTEXT
        file: ${{ inputs.container-image-file }}
        push: ${{ inputs.push-container-image }}
        sbom: true
        annotations: ${{ steps.meta.outputs.labels }}
        build-args: ${{ inputs.container-image-build-args }}
        labels: ${{ steps.meta.outputs.labels }}
        provenance: true
        tags: ${{ steps.meta.outputs.tags }}
        platforms: ${{ inputs.container-image-platforms }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    - name: Attest Build Provenance
      uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2.4.0 https://github.com/actions/attest-build-provenance/commit/e8998f949152b193b063cb0ec769d69d929409be
      if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
      with:
        subject-name: ${{ steps.build.outputs.metadata.image.name }} #${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        push-to-registry: true
        subject-digest: ${{ steps.build.outputs.digest }}
        # subject-path: ${{ inputs.container-image-file }}
